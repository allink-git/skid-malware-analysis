## Decompiles shitty python malware

import zipfile
import requests
import subprocess
import platform
import os
import psutil
import sys
import shutil

args = sys.argv
pyR = psutil.Process(os.getpid()).name()
exeDir = os.path.dirname(os.path.realpath(__file__))

def clean():
    print("[*] Cleaning up...")
    shutil.rmtree("{}/crapshit_temp/python-exe-unpacker-master".format(exeDir))
    os.remove("{}/decompShit.zip".format(exeDir))
    print("[*] Done! Check the folder \"unpacked\"!")
    exit(0)

def main():
    print("[*] Detected runtime {}!".format(pyR))
    print("[*] Downloading F-Secure python decompiler...")
    crapshit = requests.get("https://github.com/countercept/python-exe-unpacker/archive/master.zip")
    print("[*] Completed, finalizing file...")
    open("decompShit.zip","wb").write(crapshit.content)
    print("[*] Completed download!")
    print("[*] Extracting Zip...")
    zipfile.ZipFile("decompShit.zip","r").extractall("crapshit_temp")
    print("[*] Extracted Zip!")
    print("[*] Installing dependencies...")
    proc = subprocess.Popen([pyR,"-m","pip","install","-r","{}/crapshit_temp/python-exe-unpacker-master/requirements.txt".format(exeDir)])
    proc.wait()

    if(proc.returncode != 0):
        print("[!] An error occured while installing dependencies!")
        exit(proc.returncode)

    print("[*] Installed dependencies!")
    print("[*] Decompiling with python-exe-unpacker by countercept...")
    proc = subprocess.Popen([pyR,"{}/crapshit_temp/python-exe-unpacker-master/python_exe_unpack.py".format(exeDir),"-i","{}/{}".format(exeDir,args[1])])
    proc.wait()
    if proc.returncode != 0:
        print("[!] An error occured while unpacking!")
        clean()
    else:
        clean()
    exit(0)
    
if(len(args) != 0):
    main()
else:
    print("Invalid amount of arguments received! Specify the executable to decompile.")
    exit(1)